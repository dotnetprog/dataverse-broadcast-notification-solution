(function(){"use strict";function f(e,t,n){y(e,t,n,"get"),y(e,t,n,"value")}function y(e,t,n,i){if(typeof n[i]=="function"){const o=Symbol(t),a=n[i];n[i]=function(...s){let l=this,d=l[o];return typeof d>"u"&&(d=l[o]=a.apply(this,s)),d}}}class c{constructor(t,n){this._cultures={1033:t,1036:n}}toString(){const t=Xrm.Utility.getGlobalContext().userSettings.languageId;return this._cultures[t]||this._cultures[1033]}}const r={general:{MESSAGE_RECORD_DIRTY:new c("You have pending changes, please save the record.","Vous avez des modifications en attente de sauvegarde. Veuillez sauvegarder."),WAIT_POPUPTITLE:new c("Wait!","Attendez!"),CANCEL_BTN:new c("Cancel","Annuler"),PROCESSING:new c("Processing...","En traitement...")},broadcast:{PUBLISH_BTN:new c("Publish","Publier"),UNPUBLISH_BTN:new c("Unpublish","Dépublier"),NOTIFICATION_CONFIRMPUBLISH_TITLE:new c("Confirm Publish","Confirmer la publication"),NOTIFICATION_CONFIRMPUBLISH_CONTENT:new c(`Are you sure you want to publish this notification?\r
\r
This notification will be shown to users.`,`Êtes-vous sûr de vouloir publier cette notification?\r
\r
Cette notification sera affichée aux utilisateurs.`),NOTIFICATION_CONFIRMUNPUBLISH_TITLE:new c("Confirm Unpublish","Confirmer la dépublication"),NOTIFICATION_CONFIRMUNPUBLISH_CONTENT:new c(`Are you sure you want to unpublish this notification?\r
\r
This notification will no longer be shown to users.`,`Êtes-vous sûr de vouloir dépublier cette notification?\r
\r
Cette notification ne sera plus affichée aux utilisateurs.`)}};function C(e){return e.replace("{","").replace("}","")}async function F(e){return e.data.entity.getIsDirty()?(await Xrm.Navigation.openAlertDialog({title:r.general.WAIT_POPUPTITLE.toString(),text:r.general.MESSAGE_RECORD_DIRTY.toString()}),!0):!1}function p(e,t,n,i){e.getAttribute(t)?.addOnChange(n.bind(i))}var u=(e=>(e[e.Success=79456e4]="Success",e[e.Danger=794560001]="Danger",e[e.Warning=794560002]="Warning",e[e.Information=794560003]="Information",e))(u||{}),g=(e=>(e[e.English=794560001]="English",e[e.French=794560002]="French",e))(g||{}),_=(e=>(e[e.WebLink=79456e4]="WebLink",e))(_||{});function S(){switch(Xrm.Utility.getGlobalContext().userSettings.languageId){case 1036:return g.French;default:return g.English}}class R{constructor(t,n){this.webApi=t,this._storage=n,this._cacheKey="broadcast_published_{appid}",this._expirationInSeconds=60*5,this._userLang=S()}_getExpiration(){return Date.now()+this._expirationInSeconds*1e3}async getPublishedNotifications(t){const n=this._cacheKey.replace("{appid}",t),i=this._storage.getItem(n),o=Date.now();if(i){const U=JSON.parse(i);if(U.timestamp>o)return U.value;this._storage.removeItem(n)}const a=`&$filter=statuscode eq 2 and fdn_appmoduleid eq '${t}'&$orderby=fdn_level asc`,s=["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level","fdn_buttondefaulttext","fdn_buttonactionurl","fdn_actiontype"],d=`&$expand=fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification($select=${["fdn_language","fdn_contentmessage","fdn_actionbuttondisplaytext"].join(",")};$filter=statecode eq 0)`,N=`?$select=${s.join(",")}`+d+a,E=(await this.webApi.retrieveMultipleRecords("fdn_broadcastappnotification",N)).entities,Y={value:E.map(x),timestamp:this._getExpiration()};return this._storage.setItem(n,JSON.stringify(Y)),E}async Publish(t){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",t,{statecode:1,statuscode:2})}async Unpublish(t){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",t,{statecode:0,statuscode:1})}}function x(e){let n=T(e,["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level","fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification","fdn_buttondefaulttext","fdn_buttonactionurl","fdn_actiontype"]);const i=n.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification;return!i||i.length===0||i.map(o=>T(o,["fdn_contentmessage","fdn_language","fdn_actionbuttondisplaytext"])),n}function T(e,t){for(const n in e)t.includes(n)||delete e[n];return e}class B{constructor(t){this._storage=t,this._storageCacheKey="broascast_{appid}"}getCachedNotifications(t){const n=this._storageCacheKey.replace("{appid}",t),i=this._storage.getItem(n);return i?JSON.parse(i):[]}setCachedNotifications(t,n){const i=this._storageCacheKey.replace("{appid}",t),o=n??[];this._storage.setItem(i,JSON.stringify(o))}}const D={[u.Success.toString()]:1,[u.Danger.toString()]:2,[u.Warning.toString()]:3,[u.Information.toString()]:4};class X{constructor(){this._buildAction=(t,n)=>{if(t.fdn_actiontype==_.WebLink)return{actionLabel:n?.fdn_actionbuttondisplaytext??t.fdn_buttondefaulttext,eventHandler:()=>{window.open(t.fdn_buttonactionurl,"_blank")}}}}create(t){const n=S(),i=D[t.fdn_level.toString()];let o=t.fdn_message;const a=t.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification,s=a&&a.length>0?a.find(l=>l.fdn_language===n):void 0;return s!=null&&(o=s.fdn_contentmessage??t.fdn_message),{level:i,message:o,showCloseButton:!1,type:2,action:this._buildAction(t,s)}}}const M=new X,w=new B(window.localStorage),b=new R(Xrm.WebApi,window.sessionStorage);class ${async renderNotifications(t){try{const n=Xrm.Utility.getPageContext()?.input?.pageType;if(!n||n!==t)return!1;console.log("broadcast renderNotifications");const i=await Xrm.Utility.getGlobalContext().getCurrentAppProperties();if(!i||!i.appId)return!1;const a=w.getCachedNotifications(i.appId).map(d=>Xrm.App.clearGlobalNotification(d.uid)),s=await b.getPublishedNotifications(i.appId);await Promise.all(a);const l=[];for(const d of s){const N=M.create(d),v=await Xrm.App.addGlobalNotification(N);l.push({uid:v,data:d})}w.setCachedNotifications(i.appId,l)}catch(n){console.error(n)}finally{return!1}}}class z{async PublishNotification(t){const n=C(t.data.entity.getId());if(await F(t))return;const o={text:r.broadcast.NOTIFICATION_CONFIRMPUBLISH_CONTENT.toString(),title:r.broadcast.NOTIFICATION_CONFIRMPUBLISH_TITLE.toString(),confirmButtonLabel:r.broadcast.PUBLISH_BTN.toString(),cancelButtonLabel:r.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(o)).confirmed&&(Xrm.Utility.showProgressIndicator(r.general.PROCESSING.toString()),await b.Publish(n),t.data.refresh(!1),t.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}async UnpublishNotification(t){const n=C(t.data.entity.getId()),i={text:r.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_CONTENT.toString(),title:r.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_TITLE.toString(),confirmButtonLabel:r.broadcast.UNPUBLISH_BTN.toString(),cancelButtonLabel:r.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(i)).confirmed&&(Xrm.Utility.showProgressIndicator(r.general.PROCESSING.toString()),await b.Unpublish(n),t.data.refresh(!1),t.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}}var H=Object.defineProperty,G=Object.getOwnPropertyDescriptor,O=(e,t,n,i)=>{for(var o=G(t,n),a=e.length-1,s;a>=0;a--)(s=e[a])&&(o=s(t,n,o)||o);return o&&H(t,n,o),o};class h{get application(){return new $}get fdn_broadcastappnotification(){return new z}}O([f],h.prototype,"application"),O([f],h.prototype,"fdn_broadcastappnotification");const V=new h;class W{async onLoad(t){const n=t.getFormContext();p(n,"fdn_language",this.onLanguageChange,this),p(n,"fdn_appnotificationconfigid",this.onConfigChange,this),n.ui.getFormType()==XrmEnum.FormType.Create&&m(n)}async onLanguageChange(t){const n=t.getFormContext();m(n)}async onConfigChange(t){const n=t.getFormContext();m(n)}}function m(e){const t=e.getAttribute("fdn_language"),n=e.getAttribute("fdn_appnotificationconfigid"),i=e.getAttribute("fdn_name"),a=(n.getValue()?n.getValue()[0]:null)?.name??"unknown",s=t.getSelectedOption();i.setValue(`${s.text} - ${a}`)}const A={[_.WebLink.toString()]:{name:"tab_action_section_url",mandatoryFields:["fdn_buttondefaulttext","fdn_buttonactionurl"]}};class k{async onLoad(t){const n=t.getFormContext();p(n,"fdn_actiontype",this.onActionTypeChange,this),P(n)}async onActionTypeChange(t){const n=t.getFormContext();P(n)}}function P(e){const t=e.getAttribute("fdn_actiontype"),n=e.ui.tabs.get("tab_action"),i=t.getValue()??-1;for(let o in A){const a=A[o],s=i.toString()===o;n.sections.get(a.name)?.setVisible(s),a.mandatoryFields.forEach(l=>{e.getAttribute(l)?.setRequiredLevel(s?"required":"none")})}}var j=Object.defineProperty,K=Object.getOwnPropertyDescriptor,L=(e,t,n,i)=>{for(var o=K(t,n),a=e.length-1,s;a>=0;a--)(s=e[a])&&(o=s(t,n,o)||o);return o&&j(t,n,o),o};class I{get fdn_localizednotificationcontent(){return new W}get fdn_broadcastappnotification(){return new k}}L([f],I.prototype,"fdn_localizednotificationcontent"),L([f],I.prototype,"fdn_broadcastappnotification");const q=new I,J={ribbon:V,forms:q};if(typeof window<"u"){const e=globalThis.XrmEnum??{FormType:{Undefined:0,Create:1,Update:2,ReadOnly:3,Disabled:4,QuickCreate:5,BulkEdit:6,ReadOptimized:11}};globalThis.XrmEnum=e,window.broadcast=window.broadcast??J}})();
//# sourceMappingURL=broadcast.js.map
