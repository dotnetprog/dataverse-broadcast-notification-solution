(function(){"use strict";function g(n,e,t){I(n,e,t,"get"),I(n,e,t,"value")}function I(n,e,t,o){if(typeof t[o]=="function"){const i=Symbol(e),a=t[o];t[o]=function(...r){let d=this,l=d[i];return typeof l>"u"&&(l=d[i]=a.apply(this,r)),l}}}class c{constructor(e,t){this._cultures={1033:e,1036:t}}toString(){const e=Xrm.Utility.getGlobalContext().userSettings.languageId;return this._cultures[e]||this._cultures[1033]}}const s={general:{MESSAGE_RECORD_DIRTY:new c("You have pending changes, please save the record.","Vous avez des modifications en attente de sauvegarde. Veuillez sauvegarder."),WAIT_POPUPTITLE:new c("Wait!","Attendez!"),CANCEL_BTN:new c("Cancel","Annuler"),PROCESSING:new c("Processing...","En traitement...")},broadcast:{PUBLISH_BTN:new c("Publish","Publier"),UNPUBLISH_BTN:new c("Unpublish","Dépublier"),NOTIFICATION_CONFIRMPUBLISH_TITLE:new c("Confirm Publish","Confirmer la publication"),NOTIFICATION_CONFIRMPUBLISH_CONTENT:new c(`Are you sure you want to publish this notification?\r
\r
This notification will be shown to users.`,`Êtes-vous sûr de vouloir publier cette notification?\r
\r
Cette notification sera affichée aux utilisateurs.`),NOTIFICATION_CONFIRMUNPUBLISH_TITLE:new c("Confirm Unpublish","Confirmer la dépublication"),NOTIFICATION_CONFIRMUNPUBLISH_CONTENT:new c(`Are you sure you want to unpublish this notification?\r
\r
This notification will no longer be shown to users.`,`Êtes-vous sûr de vouloir dépublier cette notification?\r
\r
Cette notification ne sera plus affichée aux utilisateurs.`)}};function N(n){return n.replace("{","").replace("}","")}async function A(n){return n.data.entity.getIsDirty()?(await Xrm.Navigation.openAlertDialog({title:s.general.WAIT_POPUPTITLE.toString(),text:s.general.MESSAGE_RECORD_DIRTY.toString()}),!0):!1}function C(n,e,t,o){n.getAttribute(e)?.addOnChange(t.bind(o))}function w(){switch(Xrm.Utility.getGlobalContext().userSettings.languageId){case 1036:return 794560002;default:return 794560001}}class U{constructor(e,t){this.webApi=e,this._storage=t,this._cacheKey="broadcast_published_{appid}",this._expirationInSeconds=60*5,this._userLang=w()}_getExpiration(){return Date.now()+this._expirationInSeconds*1e3}async getPublishedNotifications(e){const t=this._cacheKey.replace("{appid}",e),o=this._storage.getItem(t),i=Date.now();if(o){const P=JSON.parse(o);if(P.timestamp>i)return P.value;this._storage.removeItem(t)}const a=`&$filter=statuscode eq 2 and fdn_appmoduleid eq '${e}'&$orderby=fdn_level asc`,l=`?$select=${["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level"].join(",")}`+"&$expand=fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification($select=fdn_contentmessage,fdn_language;$filter=statecode eq 0)"+a,p=(await this.webApi.retrieveMultipleRecords("fdn_broadcastappnotification",l)).entities,m={value:p.map(v),timestamp:this._getExpiration()};return this._storage.setItem(t,JSON.stringify(m)),p}async Publish(e){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",e,{statecode:1,statuscode:2})}async Unpublish(e){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",e,{statecode:0,statuscode:1})}}function v(n){let t=T(n,["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level","fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification"]);const o=t.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification;return!o||o.length===0||o.map(i=>T(i,["fdn_contentmessage","fdn_language"])),t}function T(n,e){for(const t in n)e.includes(t)||delete n[t];return n}class L{constructor(e){this._storage=e,this._storageCacheKey="broascast_{appid}"}getCachedNotifications(e){const t=this._storageCacheKey.replace("{appid}",e),o=this._storage.getItem(t);return o?JSON.parse(o):[]}setCachedNotifications(e,t){const o=this._storageCacheKey.replace("{appid}",e),i=t??[];this._storage.setItem(o,JSON.stringify(i))}}const y=new L(window.localStorage),_=new U(Xrm.WebApi,window.sessionStorage);var u=(n=>(n[n.Success=79456e4]="Success",n[n.Danger=794560001]="Danger",n[n.Warning=794560002]="Warning",n[n.Information=794560003]="Information",n))(u||{});class E{async renderNotifications(e){try{const t=Xrm.Utility.getPageContext()?.input?.pageType;if(!t||t!==e)return!1;const o=w();console.log("broadcast renderNotifications");const i=await Xrm.Utility.getGlobalContext().getCurrentAppProperties();if(!i||!i.appId)return!1;const r=y.getCachedNotifications(i.appId).map(f=>Xrm.App.clearGlobalNotification(f.uid)),d=await _.getPublishedNotifications(i.appId);await Promise.all(r);const l=[];for(const f of d){const p=R(f,o),m=await Xrm.App.addGlobalNotification(p);l.push({uid:m,data:f})}y.setCachedNotifications(i.appId,l)}catch(t){console.error(t)}finally{return!1}}}function R(n,e){const t=B(n.fdn_level);let o=n.fdn_message;const i=n.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification;return i&&i.length>0&&(o=i.find(a=>a.fdn_language===e)?.fdn_contentmessage??n.fdn_message),{level:t,message:o,showCloseButton:!1,type:2}}function B(n){switch(n){case u.Success:return 1;case u.Danger:return 2;case u.Warning:return 3;case u.Information:return 4;default:return 4}}class D{async PublishNotification(e){const t=N(e.data.entity.getId());if(await A(e))return;const i={text:s.broadcast.NOTIFICATION_CONFIRMPUBLISH_CONTENT.toString(),title:s.broadcast.NOTIFICATION_CONFIRMPUBLISH_TITLE.toString(),confirmButtonLabel:s.broadcast.PUBLISH_BTN.toString(),cancelButtonLabel:s.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(i)).confirmed&&(Xrm.Utility.showProgressIndicator(s.general.PROCESSING.toString()),await _.Publish(t),e.data.refresh(!1),e.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}async UnpublishNotification(e){const t=N(e.data.entity.getId()),o={text:s.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_CONTENT.toString(),title:s.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_TITLE.toString(),confirmButtonLabel:s.broadcast.UNPUBLISH_BTN.toString(),cancelButtonLabel:s.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(o)).confirmed&&(Xrm.Utility.showProgressIndicator(s.general.PROCESSING.toString()),await _.Unpublish(t),e.data.refresh(!1),e.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}}var F=Object.defineProperty,X=Object.getOwnPropertyDescriptor,S=(n,e,t,o)=>{for(var i=X(e,t),a=n.length-1,r;a>=0;a--)(r=n[a])&&(i=r(e,t,i)||i);return i&&F(e,t,i),i};class h{get application(){return new E}get fdn_broadcastappnotification(){return new D}}S([g],h.prototype,"application"),S([g],h.prototype,"fdn_broadcastappnotification");const x=new h;class M{async onLoad(e){const t=e.getFormContext();C(t,"fdn_language",this.onLanguageChange,this),C(t,"fdn_appnotificationconfigid",this.onConfigChange,this),t.ui.getFormType()==XrmEnum.FormType.Create&&b(t)}async onLanguageChange(e){const t=e.getFormContext();b(t)}async onConfigChange(e){const t=e.getFormContext();b(t)}}function b(n){const e=n.getAttribute("fdn_language"),t=n.getAttribute("fdn_appnotificationconfigid"),o=n.getAttribute("fdn_name"),a=(t.getValue()?t.getValue()[0]:null)?.name??"unknown",r=e.getSelectedOption();o.setValue(`${r.text} - ${a}`)}var z=Object.defineProperty,G=Object.getOwnPropertyDescriptor,H=(n,e,t,o)=>{for(var i=G(e,t),a=n.length-1,r;a>=0;a--)(r=n[a])&&(i=r(e,t,i)||i);return i&&z(e,t,i),i};class O{get fdn_localizednotificationcontent(){return new M}}H([g],O.prototype,"fdn_localizednotificationcontent");const $=new O,V={ribbon:x,forms:$};if(typeof window<"u"){const n=globalThis.XrmEnum??{FormType:{Undefined:0,Create:1,Update:2,ReadOnly:3,Disabled:4,QuickCreate:5,BulkEdit:6,ReadOptimized:11}};globalThis.XrmEnum=n,window.broadcast=window.broadcast??V}})();
//# sourceMappingURL=broadcast.js.map
