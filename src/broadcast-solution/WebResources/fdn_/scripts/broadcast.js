(function(){"use strict";function f(n,t,e){h(n,t,e,"get"),h(n,t,e,"value")}function h(n,t,e,o){if(typeof e[o]=="function"){const i=Symbol(t),a=e[o];e[o]=function(...s){let l=this,u=l[i];return typeof u>"u"&&(u=l[i]=a.apply(this,s)),u}}}class c{constructor(t,e){this._cultures={1033:t,1036:e}}toString(){const t=Xrm.Utility.getGlobalContext().userSettings.languageId;return this._cultures[t]||this._cultures[1033]}}const r={general:{MESSAGE_RECORD_DIRTY:new c("You have pending changes, please save the record.","Vous avez des modifications en attente de sauvegarde. Veuillez sauvegarder."),WAIT_POPUPTITLE:new c("Wait!","Attendez!"),CANCEL_BTN:new c("Cancel","Annuler"),PROCESSING:new c("Processing...","En traitement...")},broadcast:{PUBLISH_BTN:new c("Publish","Publier"),UNPUBLISH_BTN:new c("Unpublish","Dépublier"),NOTIFICATION_CONFIRMPUBLISH_TITLE:new c("Confirm Publish","Confirmer la publication"),NOTIFICATION_CONFIRMPUBLISH_CONTENT:new c(`Are you sure you want to publish this notification?\r
\r
This notification will be shown to users.`,`Êtes-vous sûr de vouloir publier cette notification?\r
\r
Cette notification sera affichée aux utilisateurs.`),NOTIFICATION_CONFIRMUNPUBLISH_TITLE:new c("Confirm Unpublish","Confirmer la dépublication"),NOTIFICATION_CONFIRMUNPUBLISH_CONTENT:new c(`Are you sure you want to unpublish this notification?\r
\r
This notification will no longer be shown to users.`,`Êtes-vous sûr de vouloir dépublier cette notification?\r
\r
Cette notification ne sera plus affichée aux utilisateurs.`)}};function b(n){return n.replace("{","").replace("}","")}async function P(n){return n.data.entity.getIsDirty()?(await Xrm.Navigation.openAlertDialog({title:r.general.WAIT_POPUPTITLE.toString(),text:r.general.MESSAGE_RECORD_DIRTY.toString()}),!0):!1}function m(n,t,e,o){n.getAttribute(t)?.addOnChange(e.bind(o))}function I(){switch(Xrm.Utility.getGlobalContext().userSettings.languageId){case 1036:return 794560002;default:return 794560001}}class A{constructor(t,e){this.webApi=t,this._storage=e,this._cacheKey="broadcast_published_{appid}",this._expirationInSeconds=60*5,this._userLang=I()}_getExpiration(){return Date.now()+this._expirationInSeconds*1e3}async getPublishedNotifications(t){const e=this._cacheKey.replace("{appid}",t),o=this._storage.getItem(e),i=Date.now();if(o){const O=JSON.parse(o);if(O.timestamp>i)return O.value;this._storage.removeItem(e)}const a=`&$filter=statuscode eq 2 and fdn_appmoduleid eq '${t}'&$orderby=fdn_level asc`,u=`?$select=${["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level"].join(",")}`+"&$expand=fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification($select=fdn_contentmessage,fdn_language;$filter=statecode eq 0)"+a,S=(await this.webApi.retrieveMultipleRecords("fdn_broadcastappnotification",u)).entities,V={value:S.map(U),timestamp:this._getExpiration()};return this._storage.setItem(e,JSON.stringify(V)),S}async Publish(t){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",t,{statecode:1,statuscode:2})}async Unpublish(t){await Xrm.WebApi.updateRecord("fdn_broadcastappnotification",t,{statecode:0,statuscode:1})}}function U(n){let e=N(n,["fdn_appmoduleid","fdn_message","fdn_broadcastappnotificationid","fdn_level","fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification"]);const o=e.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification;return!o||o.length===0||o.map(i=>N(i,["fdn_contentmessage","fdn_language"])),e}function N(n,t){for(const e in n)t.includes(e)||delete n[e];return n}const p=new A(Xrm.WebApi,window.sessionStorage);class v{constructor(t){this._storage=t,this._storageCacheKey="broascast_{appid}"}getCachedNotifications(t){const e=this._storageCacheKey.replace("{appid}",t),o=this._storage.getItem(e);return o?JSON.parse(o):[]}setCachedNotifications(t,e){const o=this._storageCacheKey.replace("{appid}",t),i=e??[];this._storage.setItem(o,JSON.stringify(i))}}const C=new v(window.localStorage);var d=(n=>(n[n.Success=79456e4]="Success",n[n.Danger=794560001]="Danger",n[n.Warning=794560002]="Warning",n[n.Information=794560003]="Information",n))(d||{});class L{async renderNotifications(){try{const t=I();console.log("broadcast renderNotifications");const e=await Xrm.Utility.getGlobalContext().getCurrentAppProperties();if(!e||!e.appId)return;const i=C.getCachedNotifications(e.appId).map(l=>Xrm.App.clearGlobalNotification(l.uid)),a=await p.getPublishedNotifications(e.appId);await Promise.all(i);const s=[];for(const l of a){const u=E(l,t),y=await Xrm.App.addGlobalNotification(u);s.push({uid:y,data:l})}C.setCachedNotifications(e.appId,s)}catch(t){console.error(t)}finally{return!1}}}function E(n,t){const e=R(n.fdn_level);let o=n.fdn_message;const i=n.fdn_localizednotificationcontent_AppNotificationConfigId_fdn_broadcastappnotification;return i&&i.length>0&&(o=i.find(a=>a.fdn_language===t)?.fdn_contentmessage??n.fdn_message),{level:e,message:o,showCloseButton:!1,type:2}}function R(n){switch(n){case d.Success:return 1;case d.Danger:return 2;case d.Warning:return 3;case d.Information:return 4;default:return 4}}class B{async PublishNotification(t){const e=b(t.data.entity.getId());if(await P(t))return;const i={text:r.broadcast.NOTIFICATION_CONFIRMPUBLISH_CONTENT.toString(),title:r.broadcast.NOTIFICATION_CONFIRMPUBLISH_TITLE.toString(),confirmButtonLabel:r.broadcast.PUBLISH_BTN.toString(),cancelButtonLabel:r.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(i)).confirmed&&(Xrm.Utility.showProgressIndicator(r.general.PROCESSING.toString()),await p.Publish(e),t.data.refresh(!1),t.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}async UnpublishNotification(t){const e=b(t.data.entity.getId()),o={text:r.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_CONTENT.toString(),title:r.broadcast.NOTIFICATION_CONFIRMUNPUBLISH_TITLE.toString(),confirmButtonLabel:r.broadcast.UNPUBLISH_BTN.toString(),cancelButtonLabel:r.general.CANCEL_BTN.toString()};(await Xrm.Navigation.openConfirmDialog(o)).confirmed&&(Xrm.Utility.showProgressIndicator(r.general.PROCESSING.toString()),await p.Unpublish(e),t.data.refresh(!1),t.ui.refreshRibbon(!0),Xrm.Utility.closeProgressIndicator())}}var D=Object.defineProperty,F=Object.getOwnPropertyDescriptor,w=(n,t,e,o)=>{for(var i=F(t,e),a=n.length-1,s;a>=0;a--)(s=n[a])&&(i=s(t,e,i)||i);return i&&D(t,e,i),i};class g{get application(){return new L}get fdn_broadcastappnotification(){return new B}}w([f],g.prototype,"application"),w([f],g.prototype,"fdn_broadcastappnotification");const X=new g;class x{async onLoad(t){const e=t.getFormContext();m(e,"fdn_language",this.onLanguageChange,this),m(e,"fdn_appnotificationconfigid",this.onConfigChange,this),e.ui.getFormType()==XrmEnum.FormType.Create&&_(e)}async onLanguageChange(t){const e=t.getFormContext();_(e)}async onConfigChange(t){const e=t.getFormContext();_(e)}}function _(n){const t=n.getAttribute("fdn_language"),e=n.getAttribute("fdn_appnotificationconfigid"),o=n.getAttribute("fdn_name"),a=(e.getValue()?e.getValue()[0]:null)?.name??"unknown",s=t.getSelectedOption();o.setValue(`${s.text} - ${a}`)}var M=Object.defineProperty,z=Object.getOwnPropertyDescriptor,G=(n,t,e,o)=>{for(var i=z(t,e),a=n.length-1,s;a>=0;a--)(s=n[a])&&(i=s(t,e,i)||i);return i&&M(t,e,i),i};class T{get fdn_localizednotificationcontent(){return new x}}G([f],T.prototype,"fdn_localizednotificationcontent");const H=new T,$={ribbon:X,forms:H};if(typeof window<"u"){const n=globalThis.XrmEnum??{FormType:{Undefined:0,Create:1,Update:2,ReadOnly:3,Disabled:4,QuickCreate:5,BulkEdit:6,ReadOptimized:11}};globalThis.XrmEnum=n,window.broadcast=window.broadcast??$}})();
//# sourceMappingURL=broadcast.js.map
